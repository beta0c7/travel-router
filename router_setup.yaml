- name: Setup Travel Router
  hosts: localhost
  connection: local
  become: yes

  # Default variables
  vars:
    wifi_ssid: "TravelRouterDefault"
    wifi_password: "ChangeMe123!"
    wifi_channel: "36"
    country_code: "US"
    admin_password: "secret"
    # Detect config location (Bookworm vs Bullseye)
    config_file: "{{ '/boot/firmware/config.txt' if query('file', '/boot/firmware/config.txt') else '/boot/config.txt' }}"

  tasks:
    # --- STEP 1: SYSTEM PREP ---
    # Task A: Update the OS
    - name: Update and upgrade apt packages
      apt:
        update_cache: yes
        upgrade: dist
        cache_valid_time: 3600

    # Task B: Install specific tools
    - name: Install required dependencies
      apt:
        pkg:
          - i2c-tools
          - util-linux
          - python3-pip
          - git
          - php-cli
        state: present

    # --- STEP 2: HARDWARE (I2C & RTC) ---
    - name: Enable I2C interface
      lineinfile:
        path: "{{ config_file }}"
        regexp: '^dtparam=i2c_arm='
        line: 'dtparam=i2c_arm=on'
        state: present

    - name: Add RTC Overlay
      lineinfile:
        path: "{{ config_file }}"
        line: 'dtoverlay=i2c-rtc,ds3231'
        state: present

    - name: Load i2c-dev module
      lineinfile:
        path: /etc/modules
        line: 'i2c-dev'
        state: present

    # --- STEP 3: INSTALL RASPAP ---
    - name: Install RaspAP (Non-interactive)
      shell: curl -sL https://install.raspap.com | bash -s -- -y
      args:
        creates: /var/www/html/index.php

    # --- STEP 4: CONFIGURATION ---
    
    # 1. Generate the Hash using PHP
    - name: Generate Admin Password Hash
      shell: php -r 'echo password_hash("{{ admin_password }}", PASSWORD_BCRYPT);'
      register: admin_pass_hash
      changed_when: false

    # 2. Write the Hashed Password (Newline Format)
    - name: Update RaspAP Admin Password
      copy:
        dest: /etc/raspap/raspap.auth
        # This format ensures:
        # Line 1: admin
        # Line 2: $2y$10$... (The Hash)
        content: |
          admin
          {{ admin_pass_hash.stdout }}
        owner: root
        group: www-data
        mode: '0640'

    # 3. DNS Configuration (The Fix for AdBlock + Internet)
    
    # A. Tell Clients (Phones) to use the Pi (10.3.141.1) so AdBlock works
    - name: Configure Clients to use Pi DNS
      lineinfile:
        path: /etc/dnsmasq.d/090_raspap.conf
        regexp: '^dhcp-option=6'
        line: 'dhcp-option=6,10.3.141.1'
        state: present
      notify: Restart Dnsmasq

    # B. Tell the Pi to use Cloudflare/Google for real Internet
    - name: Configure Upstream DNS (1.1.1.1, 8.8.8.8)
      blockinfile:
        path: /etc/dnsmasq.d/090_raspap.conf
        marker: "# {mark} ANSIBLE UPSTREAM DNS"
        block: |
          server=1.1.1.1
          server=8.8.8.8
      notify: Restart Dnsmasq
    
    # 4. Deploy WiFi Config
    - name: Deploy Custom Hostapd Config
      template:
        src: "{{ playbook_dir }}/files/hostapd.conf.j2"
        dest: /etc/hostapd/hostapd.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart Hostapd

    # 5. Deploy LED Scripts
    - name: Deploy LED Status Script
      copy:
        src: "{{ playbook_dir }}/files/router_status.sh"
        dest: /usr/local/bin/router_status.sh
        mode: '0755'

    - name: Create LED Service
      copy:
        dest: /etc/systemd/system/router-led.service
        content: |
          [Unit]
          Description=Router Status LED indicator
          After=network.target

          [Service]
          ExecStart=/usr/local/bin/router_status.sh
          Restart=always
          User=root

          [Install]
          WantedBy=multi-user.target
      notify: Reload Systemd

    - name: Enable LED Service
      systemd:
        name: router-led
        enabled: yes
        state: started

  # --- HANDLERS ---
  handlers:
    - name: Restart Hostapd
      systemd:
        name: hostapd
        state: restarted

    - name: Restart Dnsmasq
      systemd:
        name: dnsmasq
        state: restarted

    - name: Reload Systemd
      systemd:
        daemon_reload: yes